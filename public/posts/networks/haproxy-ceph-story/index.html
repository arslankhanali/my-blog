<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>HAProxy: How Ceph Found L3 Balance | AK Blogs</title>
<link rel="icon" href="/favicon.svg" sizes="any" type="image/svg+xml" /><meta property="og:url" content="//localhost:1313/posts/networks/haproxy-ceph-story/">
  <meta property="og:site_name" content="AK Blogs">
  <meta property="og:title" content="HAProxy: How Ceph Found L3 Balance">
  <meta property="og:description" content="In a lab far away, Ceph lived across three nodes — ceph-node01, ceph-node02, and ceph-node03. Each node was a diligent guardian, managing storage and services on port 8443. But there was a problem: access was restricted, and only one gateway, a single door at IP 192.168.99.61 on port 9000, was open to outsiders. No one could knock on port 80’s door anymore — it was locked tight.
Ceph needed a wise gatekeeper to direct visitors fairly among the three nodes, so none got overwhelmed. Enter HAProxy, a simple but powerful load balancer, ready to bring harmony.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-08-04T21:45:00+10:00">
    <meta property="article:modified_time" content="2025-08-04T21:45:00+10:00">
    <meta property="article:tag" content="Haproxy">
    <meta property="article:tag" content="Ceph">
      <meta property="og:see_also" content="//localhost:1313/posts/networks/squid-rh-lab/">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="HAProxy: How Ceph Found L3 Balance">
  <meta name="twitter:description" content="In a lab far away, Ceph lived across three nodes — ceph-node01, ceph-node02, and ceph-node03. Each node was a diligent guardian, managing storage and services on port 8443. But there was a problem: access was restricted, and only one gateway, a single door at IP 192.168.99.61 on port 9000, was open to outsiders. No one could knock on port 80’s door anymore — it was locked tight.
Ceph needed a wise gatekeeper to direct visitors fairly among the three nodes, so none got overwhelmed. Enter HAProxy, a simple but powerful load balancer, ready to bring harmony.">

    <link rel="stylesheet" href="/css/custom.css">
    <link rel="stylesheet" href="/css/root.css">
    <link rel="stylesheet" href="/css/bundle.css">

      <script src="/js/copy-button.js"></script>
      <script src="/js/bundle.js"></script><script defer src="/js/search/flexsearch.compact.64594b125f7b78bdf4fa8316955922bbebb1cd6baef3f16654bfca20309f18f8.js" integrity="sha256-ZFlLEl97eL30&#43;oMWlVkiu&#43;uxzWuu8/FmVL/KIDCfGPg="></script>
<script defer src="/js/search/search.1d980f84df11f3eb7c8c5f17f541d49a0611608df179dd74fa7f06225eb56ace.js" integrity="sha256-HZgPhN8R8&#43;t8jF8X9UHUmgYRYI3xed10&#43;n8GIl61as4="></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">

</head>
<body class="notransition">
  <div id="container">
    <header id="main-header"><div role="navigation" aria-label="Main">
  <div class="nav-left">
    <a href="//localhost:1313/" style="color: inherit;">AK Blogs</a>
  </div>
  <div class="nav-right">
    <div style="position:absolute;width:0px;height:0px;">
      <div id="nav-dropdown-menu" class="hidden" href="#">
    <div class="nav-item">
      <a aria-current="true" class="ancestor" href="/posts/"
      >Posts</a>
    </div>
    <div class="nav-item">
      <a href="/homelab/"
      >Homelab</a>
    </div>
    <div class="nav-item">
      <a href="/hidden/"
      >Shadow</a>
    </div>
    <div class="nav-item">
      <a href="/about/"
      >About</a>
    </div>
</div>
    </div>
    <a id="nav-dropdown-button" href="#"><svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M4 6H20M4 12H20M4 18H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</a>
    <div id="nav-menu">
    <div class="nav-item">
      <a aria-current="true" class="ancestor" href="/posts/"
      >Posts</a>
    </div>
    <div class="nav-item">
      <a href="/homelab/"
      >Homelab</a>
    </div>
    <div class="nav-item">
      <a href="/hidden/"
      >Shadow</a>
    </div>
    <div class="nav-item">
      <a href="/about/"
      >About</a>
    </div>
</div>
    <a id="theme-switcher" href="#">
<svg class="light-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M12 3V4M12 20V21M4 12H3M6.31412 6.31412L5.5 5.5M17.6859 6.31412L18.5 5.5M6.31412 17.69L5.5 18.5001M17.6859 17.69L18.5 18.5001M21 12H20M16 12C16 14.2091 14.2091 16 12 16C9.79086 16 8 14.2091 8 12C8 9.79086 9.79086 8 12 8C14.2091 8 16 9.79086 16 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>

<svg class="dark-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M3.32031 11.6835C3.32031 16.6541 7.34975 20.6835 12.3203 20.6835C16.1075 20.6835 19.3483 18.3443 20.6768 15.032C19.6402 15.4486 18.5059 15.6834 17.3203 15.6834C12.3497 15.6834 8.32031 11.654 8.32031 6.68342C8.32031 5.50338 8.55165 4.36259 8.96453 3.32996C5.65605 4.66028 3.32031 7.89912 3.32031 11.6835Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</a>
  </div>
</div>
</header>
    <div class="flex grow">
      <div id="main-pane">
        <main id="main-content"><div class="single-header">
<ol class="breadcrumbs" itemscope itemtype="https://schema.org/BreadcrumbList">
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a itemprop="item" href="//localhost:1313/">
        <span itemprop="name">Home</span>
      </a>
      <meta itemprop="position" content='1' />
    </li>
    <span>&nbsp»&nbsp</span>
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a itemprop="item" href="//localhost:1313/posts/">
        <span itemprop="name">Posts</span>
      </a>
      <meta itemprop="position" content='2' />
    </li>
    <span>&nbsp»&nbsp</span>
</ol>
<h1>HAProxy: How Ceph Found L3 Balance</h1><time class="dim" datetime="2025-08-04T21:45:00&#43;10:00">August 4, 2025</time><div class="term-container"><div class="tag">
        <a href="//localhost:1313/tags/haproxy/">#haproxy</a>
      </div><div class="tag">
        <a href="//localhost:1313/tags/ceph/">#ceph</a>
      </div></ol></div>
  <section class="page-section"><p><img src="/basic-haproxy/haproxy.png" alt="haproxy">
In a lab far away, Ceph lived across three nodes — <code>ceph-node01</code>, <code>ceph-node02</code>, and <code>ceph-node03</code>. Each node was a diligent guardian, managing storage and services on port <strong>8443</strong>. But there was a problem: access was restricted, and only one gateway, a single door at IP <code>192.168.99.61</code> on port <strong>9000</strong>, was open to outsiders. No one could knock on port 80’s door anymore — it was locked tight.</p>
<p>Ceph needed a wise gatekeeper to direct visitors fairly among the three nodes, so none got overwhelmed. Enter <strong>HAProxy</strong>, a simple but powerful load balancer, ready to bring harmony.</p>
<h3 id="the-challenge">The Challenge</h3>
<ul>
<li>The Ceph nodes spoke securely on port <strong>8443</strong>.</li>
<li>Only port <strong>9000</strong> was reachable from outside.</li>
<li>SELinux guarded the system fiercely, preventing rogue processes from binding unusual ports or making unexpected connections.</li>
</ul>
<h3 id="haproxy-to-the-rescue">HAProxy to the Rescue</h3>
<p>HAProxy was installed quietly with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dnf -y install haproxy
</span></span></code></pre></div><p>To convince SELinux to trust HAProxy’s new role, the magic command was cast:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>setsebool -P haproxy_connect_any<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>With trust secured, HAProxy configured its front door by listening on <code>192.168.99.61:9000</code> and redirecting incoming visitors to the three Ceph nodes in a balanced, round-robin dance.</p>
<h3 id="the-configuration-story">The Configuration Story</h3>
<p>A little script was written to tell HAProxy exactly how to guide visitors:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># frontend_ip=&#34;192.168.99.61&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># frontend_port=&#34;9000&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># backend_ips=(&#34;192.168.99.61&#34; &#34;192.168.99.62&#34; &#34;192.168.99.63&#34;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># backend_hostnames=(&#34;ceph-node01&#34; &#34;ceph-node02&#34; &#34;ceph-node03&#34;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># backend_port=&#34;8443&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat &gt; /etc/haproxy/haproxy.cfg <span style="color:#e6db74">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">frontend ceph_front
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    bind 192.168.99.61:9000
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    default_backend ceph_back
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">backend ceph_back
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    balance roundrobin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    server ceph-node01 192.168.99.61:8443 check
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    server ceph-node02 192.168.99.62:8443 check
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    server ceph-node03 192.168.99.63:8443 check
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl restart haproxy
</span></span></code></pre></div><p>This script is HAProxy’s map and guide, balancing load and checking if each Ceph node is ready to receive guests.</p>
<h3 id="the-happy-ending">The Happy Ending</h3>
<p>Visitors came knocking on <code>https://192.168.99.61:9000</code>, unaware of the careful orchestration behind the scenes. HAProxy gracefully sent each visitor to a Ceph node in turn, ensuring no one node was overwhelmed.</p>
<p>SELinux nodded approvingly, and the lab stayed secure.</p>
<p>You can test this harmony yourself:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -k https://192.168.99.61:9000
</span></span></code></pre></div><h3 id="lessons-from-cephs-story">Lessons from Ceph’s Story</h3>
<table>
  <thead>
      <tr>
          <th>Problem</th>
          <th>Solution</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Restricted port access</td>
          <td>Use HAProxy on an allowed port (9000)</td>
      </tr>
      <tr>
          <td>Multiple backend servers</td>
          <td>Round-robin load balancing</td>
      </tr>
      <tr>
          <td>SELinux blocking connections</td>
          <td>Enable <code>haproxy_connect_any</code> boolean</td>
      </tr>
      <tr>
          <td>Dynamic backend management</td>
          <td>Scripted configuration for easy updates</td>
      </tr>
  </tbody>
</table>
<p>In your own labs, think of HAProxy as the wise gatekeeper, balancing requests with fairness, security, and simplicity — just like Ceph needed.</p>
<hr>
<p>This story shows how small tweaks and a simple tool can solve network puzzles and keep services running smoothly.</p>
<p><img src="https://images.unsplash.com/photo-1499744937866-d7e566a20a61?q=80&amp;w=2070&amp;auto=format&amp;fit=crop&amp;ixlib=rb-4.1.0&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="thank you"></p>
</section></main>
        <footer id="main-footer">
<script src="/js/copy-button.min.4876b98121977026b3ce53c9cb225d818299becf2f6ba9c345fdfbc99911d6dd.js" integrity="sha256-SHa5gSGXcCazzlPJyyJdgYKZvs8va6nDRf37yZkR1t0="></script>
</footer>
      </div><aside id="side-pane" class="side-sticky"><div class="side-content">
      <h3>Please note</h3><p>Code blocks can be EDITED before you copy</p>
    </div><div class="side-details">
    <span>394 words</span>
    <span>3 - 3 minutes read</span><div class="side-details-taxonomy">
        <small>series: 
          <span class="details-taxonomy"><a href="//localhost:1313/series/networking">networking</a></span></small>
      </div><div class="side-details-taxonomy">
        <small>topics: 
          <span class="details-taxonomy"><a href="//localhost:1313/topics/deployment">deployment</a></span></small>
      </div></div><h3>Table Of Contents</h3><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#the-challenge">The Challenge</a></li>
        <li><a href="#haproxy-to-the-rescue">HAProxy to the Rescue</a></li>
        <li><a href="#the-configuration-story">The Configuration Story</a></li>
        <li><a href="#the-happy-ending">The Happy Ending</a></li>
        <li><a href="#lessons-from-cephs-story">Lessons from Ceph’s Story</a></li>
      </ul>
    </li>
  </ul>
</nav></aside></div>
  </div>
</body>
</html>
